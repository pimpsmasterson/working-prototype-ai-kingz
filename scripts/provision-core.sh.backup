#!/bin/bash
# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘   ğŸ‘‘ AI KINGS COMFYUI - CORE PROVISIONER v3.0                                â•‘
# â•‘                                                                               â•‘
# â•‘   âœ“ System Packages & Dependencies                                           â•‘
# â•‘   âœ“ PyTorch 2.5.1+cu124 (Python 3.12 compatible)                            â•‘
# â•‘   âœ“ ComfyUI + Custom Nodes                                                   â•‘
# â•‘   âœ“ Essential Models (Checkpoints, LoRAs, Wan, Flux)                        â•‘
# â•‘   âœ“ NO WORKFLOWS (use provision-workflows.sh separately)                     â•‘
# â•‘                                                                               â•‘
# â•‘   Goal: Get ComfyUI running FAST - workflows come later!                     â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -euo pipefail

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONFIGURATION & LOGGING
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
LOG_FILE="/tmp/provision_core.log"
log() { echo "$(date '+%H:%M:%S') $*" | tee -a "$LOG_FILE"; }
log_section() { log ""; log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"; log "$*"; log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"; }

check_required_cmds() {
    REQUIRED_CMDS=("aria2c" "git" "python3" "curl" "df" "awk")
    for cmd in "${REQUIRED_CMDS[@]}"; do
        command -v "$cmd" >/dev/null 2>&1 || { echo >&2 "âŒ REQUIRED CMD MISSING: $cmd"; exit 1; }
    done
}

validate_civitai_token() {
    if [[ -z "$CIVITAI_TOKEN" ]]; then
        log "âš ï¸  Warning: CIVITAI_TOKEN not set - Civitai downloads will fail"
        log "   Set token with: export CIVITAI_TOKEN='your_token_here'"
        return 1
    fi

    local test_url="https://civitai.com/api/v1/models/290640"
    local response=$(curl -s -w "%{http_code}" -o /dev/null \
        -H "Authorization: Bearer $CIVITAI_TOKEN" \
        "$test_url" 2>/dev/null || echo "000")

    if [[ "$response" == "200" ]]; then
        log "âœ… Civitai token validated successfully"
        return 0
    elif [[ "$response" == "401" ]]; then
        log "âŒ Civitai token INVALID or EXPIRED"
        log "   Get new token from: https://civitai.com/user/account"
        return 1
    else
        log "âš ï¸  Could not validate Civitai token (HTTP $response) - proceeding anyway"
        return 0
    fi
}

log "ğŸš€ Starting AI KINGS Core Provisioner v3.0..."

# Workspace setup
DEFAULT_WS=${WORKSPACE:-/workspace}
if mkdir -p "$DEFAULT_WS" 2>/dev/null && cd "$DEFAULT_WS" 2>/dev/null; then
  WORKSPACE="$PWD"
fi

# Disk space check
REQUIRED_GB=50
AVAILABLE_KB=$(df "$WORKSPACE" | awk 'NR==2 {print $4}')
if (( AVAILABLE_KB < REQUIRED_GB * 1024 * 1024 )); then
    log "âš ï¸  Low disk space in $WORKSPACE: $((AVAILABLE_KB / 1024 / 1024))GB available (need ${REQUIRED_GB}GB)"
fi

COMFYUI_DIR=${WORKSPACE}/ComfyUI
LOG_FILE="${WORKSPACE}/provision_core.log"
MAX_PAR_HF=4
MAX_PAR_CIVITAI=1

# Tokens
CIVITAI_TOKEN="${CIVITAI_TOKEN:-}"
HUGGINGFACE_HUB_TOKEN="${HUGGINGFACE_HUB_TOKEN:-}"

log "ğŸ“ Working in: $WORKSPACE"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# APT PACKAGES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
APT_PACKAGES=(
    "unrar" "p7zip-full" "unzip" "ffmpeg" "libgl1" "git-lfs" "file" "aria2" "curl"
    "python3-pip" "python3-dev" "build-essential" "libssl-dev" "libffi-dev"
    "libglib2.0-0" "libfreetype-dev" "libjpeg-dev" "libpng-dev" "libtiff-dev"
)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CUSTOM NODES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
NODES=(
    "https://github.com/ltdrdata/ComfyUI-Manager"
    "https://github.com/Kosinkadink/ComfyUI-AnimateDiff-Evolved"
    "https://github.com/Kosinkadink/ComfyUI-VideoHelperSuite"
    "https://github.com/Fannovel16/ComfyUI-Frame-Interpolation"
    "https://github.com/ltdrdata/ComfyUI-Impact-Pack"
    "https://github.com/ssitu/ComfyUI_UltimateSDUpscale"
    "https://github.com/kijai/ComfyUI-DepthAnythingV2"
    "https://github.com/pythongosssss/ComfyUI-Custom-Scripts"
    "https://github.com/kijai/ComfyUI-WanVideoWrapper"
    "https://github.com/jags111/efficiency-nodes-comfyui"
    "https://github.com/cubiq/ComfyUI_IPAdapter_plus"
    "https://github.com/Suzie1/ComfyUI_Comfyroll_CustomNodes"
    "https://github.com/rgthree/rgthree-comfy"
    "https://github.com/city96/ComfyUI-GGUF"
)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MODELS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# NOTE: Embedded Dropbox links were added to `CHECKPOINT_MODELS` on 2026-01-31
#       to make provisioning deterministic (added by automation run). The server
#       still supports dynamic link injection via `PROVISION_DROPBOX_LINKS_B64`
#       and `PROVISION_DROPBOX_LINKS` which will be appended at runtime if present.
#       See `docs/DROPBOX_INTEGRATION.md` for details and status.
CHECKPOINT_MODELS=(
    "https://www.dropbox.com/scl/fi/p0uxwux03oq90l8fxmrqx/ponyDiffusionV6XL.safetensors?rlkey=nxd5ll1idx0uk6jvsqn7l4hmo&st=qkvcwub0&dl=1|ponyDiffusionV6XL.safetensors"
    "https://www.dropbox.com/scl/fi/dd7aiju5petevb6nalinr/pmXL_v1.safetensors?rlkey=p4ukouvdd2o912ilcfbi6cqk3&st=bcxefpad&dl=1|pmXL_v1.safetensors"
    "https://www.dropbox.com/scl/fi/v52p66ci8u7n8r5cqc1pi/dreamshaper_8.safetensors?rlkey=4f0133r062xr8nafpsxp2h9gq&st=5dqnp5wh&dl=1|dreamshaper_8.safetensors"
    # DISABLED: Civitai link failing - add Dropbox link if you have it
    # "https://civitai.com/api/download/models/122606|revAnimated_v122.safetensors"
    "https://www.dropbox.com/scl/fi/hy476rxzeacsx8g3aodj0/pony_realism_v2.2.safetensors?rlkey=09k5sba46pqoptdu7h1tu03b4&st=jdk4lqsq&dl=1|pony_realism_v2.2.safetensors"
    "https://www.dropbox.com/scl/fi/okhdb2r3i43l7f8hv07li/wai_illustrious_sdxl.safetensors?rlkey=t7r11yjr61ecdm0vrsgrkztc8&st=tm0bye1z&dl=1|wai_illustrious_sdxl.safetensors"
    "https://www.dropbox.com/scl/fi/eq3qqc5rnwod3ac1xfisp/Rajii-Artist-Style-V2-Illustrious.safetensors?rlkey=cvfjam45wbmye89g2mvj245lz&dl=1|Rajii-Artist-Style-V2-Illustrious.safetensors"
    "https://www.dropbox.com/scl/fi/6af8pzucgqyr0dy78eh6q/DR34MJOB_I2V_14b_LowNoise.safetensors?rlkey=pgnys4h98h343ibaro0fgwhqv&dl=1|DR34MJOB_I2V_14b_LowNoise.safetensors"
    "https://www.dropbox.com/scl/fi/8280uj9myxuf2376d13jt/pornmasterPro_noobV6.safetensors?rlkey=lmduqq3jxusts1fqqexuqz72w&dl=1|pornmasterPro_noobV6.safetensors"
    "https://www.dropbox.com/scl/fi/5whxkdo39m4w2oimcffx2/expressiveh_hentai.safetensors?rlkey=5ejkyjvethd1r7fn121x7cvs1&dl=1|expressiveh_hentai.safetensors"
    "https://www.dropbox.com/scl/fi/9drclw495plki15ynlmst/fondled.safetensors?rlkey=vh5efbuy0er4338xrkivilpnb&dl=1|fondled.safetensors"
    "https://www.dropbox.com/scl/fi/hp8t53h5ylrhkphnq4cyu/wan_dr34ml4y_all_in_one.safetensors?rlkey=9bq4clb4gmiz4rp6i8g69fl9u&dl=1|wan_dr34ml4y_all_in_one.safetensors"
    "https://www.dropbox.com/scl/fi/ym112crqb6d7sdkqz5s9j/wan_dr34mjob.safetensors?rlkey=eqzd371f86g6tsof0fcecfn8n&dl=1|wan_dr34mjob.safetensors"
    "https://www.dropbox.com/scl/fi/0g4btjch885ij3kiauffm/twerk.safetensors?rlkey=8yqxhqpvs1osat76ynxadwkh8&dl=1|twerk.safetensors"
    "https://www.dropbox.com/scl/fi/3qygk64xe2ui2ey74neto/sdxl_vae.safetensors?rlkey=xzsllv3hq5w1qx81h9b2xryq8&dl=1|sdxl_vae.safetensors"
)

LORA_MODELS=(
    # DISABLED: v2.1 removed (using v2.2 checkpoint instead)
    # "https://civitai.com/api/download/models/152309|pony_realism_v2.1.safetensors"
    "https://www.dropbox.com/scl/fi/5whxkdo39m4w2oimcffx2/expressiveh_hentai.safetensors?rlkey=5ejkyjvethd1r7fn121x7cvs1&st=qqnc1m3p&dl=1|expressiveh_hentai.safetensors"
    "https://www.dropbox.com/scl/fi/9drclw495plki15ynlmst/fondled.safetensors?rlkey=vh5efbuy0er4338xrkivilpnb&st=fyrtnto7&dl=1|fondled.safetensors"
    "https://www.dropbox.com/scl/fi/hp8t53h5ylrhkphnq4cyu/wan_dr34ml4y_all_in_one.safetensors?rlkey=9bq4clb4gmiz4rp6i8g69fl9u&st=0uc8jhe2&dl=1|wan_dr34ml4y_all_in_one.safetensors"
    "https://www.dropbox.com/scl/fi/ym112crqb6d7sdkqz5s9j/wan_dr34mjob.safetensors?rlkey=eqzd371f86g6tsof0fcecfn8n&st=rpa4v299&dl=1|wan_dr34mjob.safetensors"
    "https://www.dropbox.com/scl/fi/0g4btjch885ij3kiauffm/twerk.safetensors?rlkey=8yqxhqpvs1osat76ynxadwkh8&st=x592u9sh&dl=1|twerk.safetensors"
    "https://huggingface.co/JollyIm/Defecation/resolve/main/defecation_v1.safetensors|defecation_v1.safetensors"
)

WAN_DIFFUSION_MODELS=(
    "https://huggingface.co/Comfy-Org/Wan_2.1_ComfyUI_repackaged/resolve/main/split_files/diffusion_models/wan2.1_t2v_1.3B_fp16.safetensors|wan2.1_t2v_1.3B_fp16.safetensors"
    "https://huggingface.co/Comfy-Org/Wan_2.2_ComfyUI_Repackaged/resolve/main/split_files/diffusion_models/wan2.2_t2v_high_noise_14B_fp8_scaled.safetensors|wan2.2_t2v_high_noise_14B_fp8_scaled.safetensors"
    "https://huggingface.co/Comfy-Org/Wan_2.2_ComfyUI_Repackaged/resolve/main/split_files/diffusion_models/wan2.2_t2v_low_noise_14B_fp8_scaled.safetensors|wan2.2_t2v_low_noise_14B_fp8_scaled.safetensors"
)

WAN_CLIP_MODELS=(
    "https://huggingface.co/Comfy-Org/Wan_2.1_ComfyUI_repackaged/resolve/main/split_files/text_encoders/umt5_xxl_fp8_e4m3fn.safetensors|umt5_xxl_fp8_e4m3fn_scaled.safetensors"
)

WAN_VAE_MODELS=(
    "https://huggingface.co/Comfy-Org/Wan_2.1_ComfyUI_repackaged/resolve/main/split_files/vae/wan2.1_vae.safetensors|wan_2.1_vae.safetensors"
    "https://huggingface.co/Comfy-Org/Wan_2.2_ComfyUI_Repackaged/resolve/main/split_files/vae/wan2.2_vae.safetensors|wan2.2_vae.safetensors"
    "https://www.dropbox.com/scl/fi/3qygk64xe2ui2ey74neto/sdxl_vae.safetensors?rlkey=xzsllv3hq5w1qx81h9b2xryq8&dl=1|sdxl_vae.safetensors"
)

ANIMATEDIFF_MODELS=(
    "https://huggingface.co/camenduru/AnimateDiff-sdxl-beta/resolve/main/mm_sdxl_v10_beta.ckpt|mm_sdxl_v1_beta.ckpt"
    "https://huggingface.co/guoyww/animatediff/resolve/main/mm_sd_v15_v2.ckpt|mm_sd_v15_v2.ckpt"
)

UPSCALE_MODELS=(
    "https://huggingface.co/Kim2091/UltraSharp/resolve/main/4x-UltraSharp.pth|4x-UltraSharp.pth"
    "https://github.com/xinntao/Real-ESRGAN/releases/download/v0.1.0/RealESRGAN_x4plus.pth|RealESRGAN_x4plus.pth"
)

CONTROLNET_MODELS=(
    "https://huggingface.co/thibaud/controlnet-openpose-sdxl-1.0/resolve/main/OpenPoseXL2.safetensors|OpenPoseXL2.safetensors"
)

DETECTOR_MODELS=(
    "https://huggingface.co/Bingsu/adetailer/resolve/main/face_yolov8m.pt|face_yolov8m.pt"
    "https://huggingface.co/Bingsu/adetailer/resolve/main/hand_yolov8n.pt|hand_yolov8n.pt"
    "https://dl.fbaipublicfiles.com/segment_anything/sam_vit_b_01ec64.pth|sam_vit_b_01ec64.pth"
)

RIFE_MODELS=(
    "https://github.com/hzwer/Practical-RIFE/releases/download/v4.26/rife426.pth|rife426.pth"
)

FLUX_MODELS=(
    "https://huggingface.co/black-forest-labs/FLUX.1-dev/resolve/main/flux1-dev.safetensors|flux1-dev.safetensors"
    "https://huggingface.co/black-forest-labs/FLUX.1-schnell/resolve/main/flux1-schnell.safetensors|flux1-schnell.safetensors"
)

FLUX_VAE_MODELS=(
    "https://huggingface.co/black-forest-labs/FLUX.1-dev/resolve/main/ae.safetensors|flux_ae.safetensors"
)

FLUX_CLIP_MODELS=(
    "https://huggingface.co/comfyanonymous/flux_text_encoders/resolve/main/clip_l.safetensors|clip_l.safetensors"
    "https://huggingface.co/comfyanonymous/flux_text_encoders/resolve/main/t5xxl_fp16.safetensors|t5xxl_fp16.safetensors"
)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# FUNCTIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

VENV_PYTHON="python3"
activate_venv() {
    if [[ -f "/venv/main/bin/activate" ]]; then
        source /venv/main/bin/activate
        VENV_PYTHON="/venv/main/bin/python3"
        log "âœ… Activated venv: /venv/main"
    elif [[ -f "${WORKSPACE}/venv/bin/activate" ]]; then
        source "${WORKSPACE}/venv/bin/activate"
        VENV_PYTHON="${WORKSPACE}/venv/bin/python3"
        log "âœ… Activated venv: ${WORKSPACE}/venv"
    else
        log "ğŸ“¦ Creating virtual environment..."
        python3 -m venv "${WORKSPACE}/venv"
        source "${WORKSPACE}/venv/bin/activate"
        VENV_PYTHON="${WORKSPACE}/venv/bin/python3"
        log "âœ… Created/Activated venv: ${WORKSPACE}/venv"
    fi
}

install_torch() {
    log_section "ğŸ§  INSTALLING PYTORCH"
    activate_venv

    local python_version=$("$VENV_PYTHON" -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
    log "   Python version: $python_version"

    log "   Installing PyTorch 2.5.1+cu124 (Python 3.12 compatible)"
    "$VENV_PYTHON" -m pip install --no-cache-dir \
        torch==2.5.1+cu124 torchvision==0.20.1+cu124 torchaudio==2.5.1+cu124 \
        --index-url https://download.pytorch.org/whl/cu124 || {
        log "   âš ï¸  cu124 failed, trying cu121..."
        "$VENV_PYTHON" -m pip install --no-cache-dir \
            torch torchvision torchaudio \
            --index-url https://download.pytorch.org/whl/cu121
    }
}

install_essential_deps() {
    log_section "ğŸ“¦ INSTALLING ESSENTIAL DEPENDENCIES"
    activate_venv

    # Remove pre-installed xformers that conflicts with PyTorch version
    "$VENV_PYTHON" -m pip uninstall -y xformers 2>/dev/null || true
    log "   âœ… Removed conflicting xformers (if present)"

    # Install core dependencies
    "$VENV_PYTHON" -m pip install --no-cache-dir \
        transformers==4.36.0 \
        accelerate \
        safetensors \
        einops \
        opencv-python-headless \
        insightface \
        onnxruntime-gpu \
        sentencepiece

    # Reinstall PyTorch to ensure correct version
    "$VENV_PYTHON" -m pip install --no-cache-dir \
        torch==2.5.1+cu124 torchvision==0.20.1+cu124 torchaudio==2.5.1+cu124 \
        --index-url https://download.pytorch.org/whl/cu124 || {
        log "   âš ï¸  cu124 failed, trying cu121..."
        "$VENV_PYTHON" -m pip install --no-cache-dir \
            torch torchvision torchaudio \
            --index-url https://download.pytorch.org/whl/cu121
    }

    # Skip xformers to avoid version conflicts
    log "   â„¹ï¸  Skipping xformers to avoid PyTorch version conflicts"
    log "   (ComfyUI will work without it, though some operations may be slower)"
}

install_apt_packages() {
    log_section "ğŸ“¦ INSTALLING SYSTEM PACKAGES"
    apt-get update -qq
    apt-get install -y -qq "${APT_PACKAGES[@]}" 2>/dev/null || {
        log "âš ï¸  Some packages may have failed, continuing..."
    }
    git lfs install --skip-repo 2>/dev/null || true
}

install_comfyui() {
    log_section "ğŸ–¥ï¸  INSTALLING COMFYUI"
    if [[ ! -d "${COMFYUI_DIR}" ]]; then
        git clone --depth 1 https://github.com/comfyanonymous/ComfyUI.git "${COMFYUI_DIR}"
    fi

    cd "${COMFYUI_DIR}"
    install_torch
    install_essential_deps
    "$VENV_PYTHON" -m pip install -q -r requirements.txt
    cd "${WORKSPACE}"
    log "âœ… ComfyUI setup complete"
}

install_nodes() {
    log_section "ğŸ§© INSTALLING CUSTOM NODES"
    activate_venv

    for repo in "${NODES[@]}"; do
        repo=$(echo "$repo" | tr -d '[:space:]')
        local dir="${repo##*/}"
        local path="${COMFYUI_DIR}/custom_nodes/${dir}"

        if [[ -d "$path" ]]; then
            log "   âœ… $dir exists"
        else
            log "   ğŸ“¥ Cloning $dir..."
            git clone --depth 1 "$repo" "$path" --recursive || {
                log "   âš ï¸  Failed to clone $dir"
                continue
            }
        fi

        if [[ -f "${path}/requirements.txt" ]]; then
            "$VENV_PYTHON" -m pip install --no-cache-dir -q -r "${path}/requirements.txt" || true
        fi
    done

    "$VENV_PYTHON" -m pip install --no-cache-dir -q einops accelerate transformers opencv-python-headless sageattention huggingface-hub 2>/dev/null || true
}

download_file() {
    local url="$1"
    local dir="$2"
    local filename="$3"
    local filepath="${dir}/${filename}"

    # Skip if valid file exists
    if [[ -f "$filepath" ]]; then
        local size=$(stat -c%s "$filepath" 2>/dev/null || echo 0)
        [[ $size -gt 1000000 ]] && { log "   âœ… $filename"; return 0; }
        rm -f "$filepath"
    fi

    mkdir -p "$dir"
    local header_args=()

    # Auth handling
    if [[ -n "$CIVITAI_TOKEN" && "$url" == *"civitai.com"* ]]; then
        if [[ "$url" == *"?"* ]]; then
            url="${url}&token=$CIVITAI_TOKEN"
        else
            url="${url}?token=$CIVITAI_TOKEN"
        fi
    elif [[ -n "$HUGGINGFACE_HUB_TOKEN" && "$url" == *"huggingface.co"* ]]; then
        header_args+=("--header=Authorization: Bearer $HUGGINGFACE_HUB_TOKEN")
    fi

    log "   ğŸ“¥ $filename"

    # Try aria2c (use single connection for Dropbox to avoid rate limiting)
    if command -v aria2c &>/dev/null; then
        local connections=8
        if [[ "$url" == *"dropbox.com"* ]]; then
            connections=1
            log "      (Dropbox: using single connection to avoid rate limit)"
        fi

        aria2c "$url" -d "$dir" -o "$filename" \
               "${header_args[@]}" \
               -x${connections} -s${connections} -j1 --max-connection-per-server=${connections} \
               --timeout=300 --retry-wait=10 --max-tries=10 \
               --follow-metalink=true \
               --file-allocation=none --continue=true \
               --allow-overwrite=true \
               --auto-file-renaming=false \
               --console-log-level=warn 2>&1 | tee -a "$LOG_FILE"

        local exit_code=$?

        if [[ $exit_code -eq 0 && -f "$filepath" && $(stat -c%s "$filepath") -gt 1000000 ]]; then
            log "   âœ… $filename ($(stat -c%s "$filepath" | numfmt --to=iec-i 2>/dev/null || echo 'OK'))"
            return 0
        else
            log "   âš ï¸  aria2c failed (exit $exit_code), trying wget..."
        fi
    fi

    # Fallback to wget
    local wget_opts=("-c" "-q" "--show-progress" "--timeout=600" "--tries=10" "-O" "$filepath")
    for header in "${header_args[@]}"; do
        wget_opts+=("${header/--header=/--header=}")
    done

    if wget "${wget_opts[@]}" "$url" 2>&1 | tee -a "$LOG_FILE"; then
        if [[ -f "$filepath" && $(stat -c%s "$filepath") -gt 1000000 ]]; then
            log "   âœ… $filename ($(stat -c%s "$filepath" | numfmt --to=iec-i 2>/dev/null || echo 'OK'))"
            return 0
        fi
    fi

    # Both download methods failed
    log "   âŒ $filename - DOWNLOAD FAILED (both aria2c and wget failed)"
    log "      URL: $url"
    rm -f "$filepath"
    return 1
}

smart_download_parallel() {
    local dir="$1"
    local max_p="$2"
    shift 2
    local arr=("$@")

    local pids=()
    local count=0
    local failed_count=0

    for entry in "${arr[@]}"; do
        local url="${entry%%|*}"
        local filename="${entry##*|}"
        [[ "$filename" == "$url" ]] && filename="${url##*/}" && filename="${filename%%\?*}"

        # Sequential for Civitai (rate limit prevention)
        if [[ "$url" == *"civitai.com"* ]]; then
            download_file "$url" "$dir" "$filename" || {
                log "   âš ï¸  Civitai download failed: $filename (continuing...)"
                ((failed_count++))
            }
        else
            download_file "$url" "$dir" "$filename" &
            pids+=($!)
            ((count++))
            if (( count >= max_p )); then
                wait -n 2>/dev/null || true
                ((count--))
            fi
        fi
    done

    # Wait for background downloads
    for pid in "${pids[@]}"; do
        if ! wait "$pid" 2>/dev/null; then
            ((failed_count++))
        fi
    done

    if (( failed_count > 0 )); then
        log "   âš ï¸  $failed_count download(s) failed (non-critical, continuing)"
    fi
    return 0  # Always succeed
}

install_models() {
    log_section "ğŸ“¦ DOWNLOADING MODELS (STAGED)"

    # If the server injected Dropbox links (base64-encoded), decode and append them to CHECKPOINT_MODELS
    if [[ -n "${PROVISION_DROPBOX_LINKS_B64:-}" ]]; then
        log "ğŸ“¥ PROVISION_DROPBOX_LINKS_B64 present - decoding to $WORKSPACE/dropbox_links.txt"
        echo "${PROVISION_DROPBOX_LINKS_B64}" | base64 -d > "$WORKSPACE/dropbox_links.txt" 2>/dev/null || log "âš ï¸  Failed to decode PROVISION_DROPBOX_LINKS_B64"
        if [[ -s "$WORKSPACE/dropbox_links.txt" ]]; then
            log "ğŸ“„ Appending links from $WORKSPACE/dropbox_links.txt to CHECKPOINT_MODELS"
            while IFS= read -r line; do
                [[ -z "$line" ]] && continue
                CHECKPOINT_MODELS+=("$line")
            done < "$WORKSPACE/dropbox_links.txt"
        fi
    fi

    # Also support raw PROVISION_DROPBOX_LINKS (newline separated) for convenience
    if [[ -n "${PROVISION_DROPBOX_LINKS:-}" ]]; then
        log "ğŸ“¥ PROVISION_DROPBOX_LINKS present - writing to $WORKSPACE/dropbox_links.txt"
        printf "%s\n" "$PROVISION_DROPBOX_LINKS" > "$WORKSPACE/dropbox_links.txt"
        while IFS= read -r line; do
            [[ -z "$line" ]] && continue
            CHECKPOINT_MODELS+=("$line")
        done < "$WORKSPACE/dropbox_links.txt"
    fi

    smart_download_parallel "${COMFYUI_DIR}/models/checkpoints" "$MAX_PAR_HF" "${CHECKPOINT_MODELS[@]}"
    smart_download_parallel "${COMFYUI_DIR}/models/loras" "$MAX_PAR_HF" "${LORA_MODELS[@]}"
    smart_download_parallel "${COMFYUI_DIR}/models/diffusion_models" "$MAX_PAR_HF" "${WAN_DIFFUSION_MODELS[@]}"
    smart_download_parallel "${COMFYUI_DIR}/models/clip" "$MAX_PAR_HF" "${WAN_CLIP_MODELS[@]}"
    smart_download_parallel "${COMFYUI_DIR}/models/vae" "$MAX_PAR_HF" "${WAN_VAE_MODELS[@]}"
    smart_download_parallel "${COMFYUI_DIR}/models/animatediff_models" "$MAX_PAR_HF" "${ANIMATEDIFF_MODELS[@]}"
    smart_download_parallel "${COMFYUI_DIR}/models/upscale_models" "$MAX_PAR_HF" "${UPSCALE_MODELS[@]}"
    smart_download_parallel "${COMFYUI_DIR}/models/controlnet" "$MAX_PAR_HF" "${CONTROLNET_MODELS[@]}"
    smart_download_parallel "${COMFYUI_DIR}/custom_nodes/ComfyUI-Frame-Interpolation/ckpts/rife" "$MAX_PAR_HF" "${RIFE_MODELS[@]}"
    smart_download_parallel "${COMFYUI_DIR}/models/ultralytics/bbox" "$MAX_PAR_HF" "${DETECTOR_MODELS[@]:0:2}"
    smart_download_parallel "${COMFYUI_DIR}/models/sams" "$MAX_PAR_HF" "${DETECTOR_MODELS[@]:2:1}"
    smart_download_parallel "${COMFYUI_DIR}/models/unet" "$MAX_PAR_HF" "${FLUX_MODELS[@]}"
    smart_download_parallel "${COMFYUI_DIR}/models/vae" "$MAX_PAR_HF" "${FLUX_VAE_MODELS[@]}"
    smart_download_parallel "${COMFYUI_DIR}/models/clip" "$MAX_PAR_HF" "${FLUX_CLIP_MODELS[@]}"

    download_file "https://huggingface.co/spaces/hysts/ControlNet/resolve/main/images/pose.png" \
        "${COMFYUI_DIR}/user/default" "example_pose.png"
}

verify_installation() {
    log_section "ğŸ” VERIFYING INSTALLATION"
    local critical_nodes=(
        "${COMFYUI_DIR}/custom_nodes/ComfyUI-WanVideoWrapper"
        "${COMFYUI_DIR}/custom_nodes/ComfyUI-AnimateDiff-Evolved"
        "${COMFYUI_DIR}/custom_nodes/ComfyUI-Impact-Pack"
        "${COMFYUI_DIR}/custom_nodes/ComfyUI-Frame-Interpolation"
    )

    for node in "${critical_nodes[@]}"; do
        if [[ -d "$node" ]]; then
            log "   âœ… $(basename "$node") exists"
        else
            log "   âŒ $(basename "$node") MISSING"
        fi
    done
}

start_comfyui() {
    log_section "ğŸš€ STARTING COMFYUI"
    cd "${COMFYUI_DIR}"
    activate_venv
    setsid nohup "$VENV_PYTHON" main.py --listen 0.0.0.0 --port 8188 --enable-cors-header > "${WORKSPACE}/comfyui.log" 2>&1 < /dev/null &
    local comfyui_pid=$!
    echo "$comfyui_pid" > "${WORKSPACE}/comfyui.pid"

    # Auto-detect instance IP
    local instance_ip=$(curl -s ifconfig.me 2>/dev/null || curl -s icanhazip.com 2>/dev/null || echo "YOUR_INSTANCE_IP")

    log "âœ… ComfyUI started on port 8188 (PID: $comfyui_pid)"
    log "   Log: ${WORKSPACE}/comfyui.log"
    log "   PID file: ${WORKSPACE}/comfyui.pid"
    log "   To stop: kill \$(cat ${WORKSPACE}/comfyui.pid)"
    log ""
    log "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    log "â•‘  ğŸ¨ ComfyUI is READY! Open this URL in your browser:          â•‘"
    log "â•‘                                                                â•‘"
    log "â•‘     http://${instance_ip}:8188                                     â•‘"
    log "â•‘                                                                â•‘"
    log "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    log ""
    log "ğŸ“ Optional: Install workflows with: bash scripts/provision-workflows.sh"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MAIN EXECUTION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
main() {
    log "--- Core Provisioning Start ---"
    install_apt_packages
    check_required_cmds
    validate_civitai_token
    install_comfyui
    install_nodes
    verify_installation
    install_models
    start_comfyui
    log "--- Core Provisioning Complete ---"
    log ""
    log "âœ… ComfyUI is now running!"
    log "ğŸ“ Optional: Install workflows with: bash scripts/provision-workflows.sh"
}

main "$@"
